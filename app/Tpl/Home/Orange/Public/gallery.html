<!--弹出框-->
<div id="dialog">
  <ul>
    <li><a href="#tabs-1">在线图库</a></li>
    <li><a href="#tabs-2">本地上传</a></li>
  </ul>
  <div id="tabs-1">
    <div id="select">
      <select name="gallery_pic" id="gallery">
      </select>
    </div>
    <div id="imgList">
    </div>
  </div>
  <div id="tabs-2" style="min-height:100px;">
    <input type="file" name="pic" id="pic" onchange="handleFiles(this.files)" accept:"image/*" style="display:none;">
    <a id="picSel" href="#">上传图片</a>
    <div id="picList"></div>
    <button class="btn btn-primary" onclick="sendFiles()">开始上传</button>
  </div>
</div>
<script>
/*
function handleFiles2(files){
    var file = files[0];
    var fd = new FormData();
    fd.append("pic", file);
    fd.append('msg', 'haha');
 
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '{:U(\'Gallery/uploadImage\')}', true);
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
        var percentComplete = (e.loaded / e.total) * 100;
        console.log(percentComplete + '% uploaded');
        }
    };
 
    xhr.onload = function() {
        if (this.status == 200) {
        alert(this.response);
        };
    };
 
    xhr.send(fd);
}
*/
/* 创建拖拽上传区域 */
var dropbox;
dropbox = document.getElementById("tabs-2");
dropbox.addEventListener("dragenter", dragenter, false);
dropbox.addEventListener("dragover", dragover, false);
dropbox.addEventListener("drop", drop, false);

/* 隐藏上传图片按钮 */
window.URL = window.URL || window.webkitURL;
var fileSelect = document.getElementById("picSel"),
    fileElem = document.getElementById("pic"),
    fileList = document.getElementById("picList");
fileSelect.addEventListener("click", function (e) {
    if (fileElem) {fileElem.click();}
    e.preventDefault();}, false);
        
/* 在线图片和本地上传切换 */
$("#dialog").tabs();

/* 获取图库列表 */
$.get(
    "{:U('Home/Gallery/getGalleryList')}",
    function(data){
        $("#gallery").html(data);
    });

/* 动态加载图片信息 */
function loadImgList(){
    $("#imgList").load(
        "{:U('Home/Gallery/showImgList')}",
        {gallery_id: $("#gallery").val()}
        );
}

/* 打开会话框 */
$("#changeImg").click(function(){
    $("#dialog").dialog("open");
    $("#gallery").change(function(){loadImgList()});
    loadImgList();
    });
$("#dialog").dialog({
    autoOpen: false,
    title: '选择图片',
    height: 400,
    width: 640,
    buttons: [
    {
        text: '确定',
        click: function(){
            var img_id = $("#selImgVal").val();
            if(img_id != null){
                $("#img").val(img_id);
                }
            $(this).dialog('close')}
    },
    {
        text: '取消',
        click: function(){ $(this).dialog('close')}
    }]
})

/* 当用户选择图片后，自动上传 */
function handleFiles(files) {
    if (!files.length) {
        fileList.innerHTML = "<p>没有图片!</p>";
    } else {
        var list = document.createElement("ul");
        for (var i = 0; i < files.length; i++) {
            var li = document.createElement("li");
            list.appendChild(li);
      
            var img = document.createElement("img");
            img.classList.add("obj");
            img.src = window.URL.createObjectURL(files[i]);
            img.height = 60;
            img.onload = function(e) {
                window.URL.revokeObjectURL(this.src);
            }
            li.appendChild(img);
      
            var info = document.createElement("span");
            info.innerHTML = files[i].name + ": " + files[i].size + " bytes";
            li.appendChild(info);
        }
        fileList.appendChild(list);
    }
}

function dragenter(e) {
    e.stopPropagation();
    e.preventDefault();
}

function dragover(e) {
    e.stopPropagation();
    e.preventDefault();
}

function drop(e) {
    e.stopPropagation();
    e.preventDefault();

    var dt = e.dataTransfer;
    var files = dt.files;

    handleFiles(files);
}

function sendFiles() {
    /*
    var imgs = document.querySelectorAll(".obj");
    for (var i = 0; i < imgs.length; i++) {
        FileUpload(imgs[i], imgs[i].file);
    }
    */
    var file = $("#pic").get(0).files[0];
    FileUpload(file);
}

/** 文件上传 */
function FileUpload(img, file) {
    var uri = "{:U('Gallery/uploadImage')}";
    var xhr = new XMLHttpRequest();
    var fd = new FormData();

    xhr.open("POST", uri, true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
            alert(xhr.responseText);}
    };
    fd.append('pic', file);
    xhr.send(fd);
}
    
/*
  var reader = new FileReader();  
  //this.ctrl = createThrobber(img);
  var xhr = new XMLHttpRequest();
  this.xhr = xhr;
  
  var self = this;
  /*
  this.xhr.upload.addEventListener("progress", function(e) {
        if (e.lengthComputable) {
          var percentage = Math.round((e.loaded * 100) / e.total);
          self.ctrl.update(percentage);
        }
      }, false);
  
    xhr.upload.addEventListener("load", function(e){
        self.ctrl.update(100);
        var canvas = self.ctrl.ctx.canvas;
        canvas.parentNode.removeChild(canvas);
    }, false);
    xhr.open("POST", "{:U('Gallery/uploadImage')}", true);
    xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
    reader.onload = function(evt) {
        xhr.sendAsBinary(evt.target.result);
    };
    reader.readAsBinaryString(file);}
    */
</script>
